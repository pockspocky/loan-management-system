# ğŸ‰ ç”³è¯·äººå§“åè¦†ç›–é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

åœ¨è´·æ¬¾ç”³è¯·åŠŸèƒ½ä¸­å‘ç°ï¼Œåç«¯ä¼šè‡ªåŠ¨å°†å‰ç«¯å‘é€çš„ `applicant_name` å­—æ®µè¦†ç›–ä¸ºå½“å‰ç™»å½•ç”¨æˆ·çš„ `real_name`ï¼Œå¯¼è‡´æ— æ³•ä¸ºä»–äººä»£ç†ç”³è¯·è´·æ¬¾ã€‚

### é—®é¢˜è¡¨ç°
- **å‰ç«¯å‘é€**: `applicant_name: "å¼ ä¸‰"`
- **åç«¯ä¿å­˜**: `applicant_name: "ç³»ç»Ÿç®¡ç†å‘˜"` (å½“å‰ç”¨æˆ·å§“å)
- **ç”¨æˆ·ä½“éªŒ**: æ— æ³•ä»£ç†ä»–äººç”³è¯·è´·æ¬¾

## ğŸ”§ ä¿®å¤æªæ–½

### 1. æ›´æ–°éªŒè¯æ¨¡å¼

**æ–‡ä»¶**: `src/utils/validation.js`

```javascript
// è´·æ¬¾åˆ›å»ºéªŒè¯æ¨¡å¼
const loanCreateSchema = Joi.object({
  loan_name: Joi.string().trim().max(100).required(),
  applicant_name: Joi.string().trim().max(50).optional().messages({
    'string.max': 'ç”³è¯·äººå§“åæœ€å¤š50ä¸ªå­—ç¬¦'
  }),
  // ... å…¶ä»–å­—æ®µ
});

// è´·æ¬¾æ›´æ–°éªŒè¯æ¨¡å¼  
const loanUpdateSchema = Joi.object({
  loan_name: Joi.string().trim().max(100).optional(),
  applicant_name: Joi.string().trim().max(50).optional().messages({
    'string.max': 'ç”³è¯·äººå§“åæœ€å¤š50ä¸ªå­—ç¬¦'
  }),
  // ... å…¶ä»–å­—æ®µ
});
```

### 2. ä¿®å¤è´·æ¬¾åˆ›å»ºé€»è¾‘

**æ–‡ä»¶**: `src/routes/loans.js`

```javascript
// ä¿®å¤å‰ï¼ˆé”™è¯¯çš„åšæ³•ï¼‰
const loan = new Loan({
  loan_name,
  applicant_id: req.user._id,
  applicant_name: req.user.real_name || req.user.username, // å¼ºåˆ¶è¦†ç›–
  // ...
});

// ä¿®å¤åï¼ˆæ­£ç¡®çš„åšæ³•ï¼‰
const loan = new Loan({
  loan_name,
  applicant_id: req.user._id,
  applicant_name: applicant_name || req.user.real_name || req.user.username, // ä¼˜å…ˆä½¿ç”¨å‰ç«¯å€¼
  // ...
});
```

### 3. æ”¯æŒç”³è¯·äººå§“åæ›´æ–°

**æ–‡ä»¶**: `src/routes/loans.js`

```javascript
// æ·»åŠ åˆ°å…è®¸æ›´æ–°çš„å­—æ®µåˆ—è¡¨
const allowedFields = [
  'loan_name', 'applicant_name', 'amount', 'interest_rate', 'bank', 
  'term', 'repayment_method', 'purpose', 'collateral', 'attachments'
];
```

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **ä»£ç†ç”³è¯·æµ‹è¯•**
   - å‰ç«¯å‘é€: `applicant_name: "å¼ ä¸‰"`
   - åç«¯ä¿å­˜: `applicant_name: "å¼ ä¸‰"` âœ…
   - ç»“æœ: æ”¯æŒä»£ç†ç”³è¯·

2. **è‡ªå·±ç”³è¯·æµ‹è¯•**
   - å‰ç«¯ä¸å‘é€ `applicant_name`
   - åç«¯ä¿å­˜: `applicant_name: "æµ‹è¯•ç”¨æˆ·"` (å½“å‰ç”¨æˆ·çœŸå®å§“å) âœ…
   - ç»“æœ: è‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ·å§“å

3. **æ›´æ–°ç”³è¯·äººæµ‹è¯•**
   - æ›´æ–° `applicant_name: "æå››"`
   - åç«¯ä¿å­˜: `applicant_name: "æå››"` âœ…
   - ç»“æœ: æ”¯æŒæ›´æ–°ç”³è¯·äººå§“å

### æµ‹è¯•æ‰§è¡Œç»“æœ

```bash
$ ./test-applicant-name-fix.sh

ğŸ§ª æµ‹è¯•1: åˆ›å»ºè´·æ¬¾ç”³è¯· - æŒ‡å®šç”³è¯·äººå§“å
âœ… æµ‹è¯•1é€šè¿‡ - ç”³è¯·äººå§“åæ­£ç¡®ä¿å­˜ä¸º: å¼ ä¸‰

ğŸ§ª æµ‹è¯•2: åˆ›å»ºè´·æ¬¾ç”³è¯· - ä¸æŒ‡å®šç”³è¯·äººå§“å  
âœ… æµ‹è¯•2é€šè¿‡ - æœªæŒ‡å®šç”³è¯·äººæ—¶ä½¿ç”¨å½“å‰ç”¨æˆ·å§“å: æµ‹è¯•ç”¨æˆ·

ğŸ§ª æµ‹è¯•3: æ›´æ–°è´·æ¬¾ç”³è¯·äººå§“å
âœ… æµ‹è¯•3é€šè¿‡ - ç”³è¯·äººå§“åæˆåŠŸæ›´æ–°ä¸º: æå››

ğŸ‰ ç”³è¯·äººå§“åè¦†ç›–é—®é¢˜ä¿®å¤å®Œæˆï¼
```

## ğŸ¯ ä¸šåŠ¡é€»è¾‘è¯´æ˜

### å½“å‰å®ç° (æ¨è)
- **ä¼˜å…ˆä½¿ç”¨å‰ç«¯å‘é€çš„ç”³è¯·äººå§“å** - æ”¯æŒä»£ç†ç”³è¯·
- **æœªæŒ‡å®šæ—¶ä½¿ç”¨å½“å‰ç”¨æˆ·å§“å** - ä¿è¯æ•°æ®å®Œæ•´æ€§
- **æ”¯æŒåç»­æ›´æ–°ç”³è¯·äººå§“å** - çµæ´»æ€§

### APIè¡Œä¸º

#### åˆ›å»ºè´·æ¬¾ç”³è¯·
```http
POST /api/v1/loans
{
  "loan_name": "å¼ ä¸‰ä»£ç†ç”³è¯·",
  "applicant_name": "å¼ ä¸‰",  // å¯é€‰å­—æ®µ
  "amount": 100000,
  // ... å…¶ä»–å­—æ®µ
}

å“åº”:
{
  "success": true,
  "data": {
    "loan": {
      "applicant_name": "å¼ ä¸‰",  // ä½¿ç”¨å‰ç«¯å‘é€çš„å€¼
      // ...
    }
  }
}
```

#### æ›´æ–°è´·æ¬¾ä¿¡æ¯
```http
PUT /api/v1/loans/:id
{
  "applicant_name": "æå››"  // æ”¯æŒæ›´æ–°
}

å“åº”:
{
  "success": true,
  "data": {
    "loan": {
      "applicant_name": "æå››",  // æ›´æ–°æˆåŠŸ
      // ...
    }
  }
}
```

## ğŸ“ æ–‡ä»¶å˜æ›´æ¸…å•

1. **src/utils/validation.js**
   - åœ¨ `loanCreateSchema` ä¸­æ·»åŠ  `applicant_name` å­—æ®µ
   - åœ¨ `loanUpdateSchema` ä¸­æ·»åŠ  `applicant_name` å­—æ®µ

2. **src/routes/loans.js**
   - ä¿®æ”¹è´·æ¬¾åˆ›å»ºé€»è¾‘ï¼Œä¼˜å…ˆä½¿ç”¨å‰ç«¯å‘é€çš„ç”³è¯·äººå§“å
   - åœ¨å…è®¸æ›´æ–°å­—æ®µåˆ—è¡¨ä¸­æ·»åŠ  `applicant_name`
   - åœ¨æ—¥å¿—è®°å½•ä¸­æ·»åŠ  `applicant_name` ä¿¡æ¯

3. **test-applicant-name-fix.sh**
   - åˆ›å»ºå®Œæ•´çš„ä¿®å¤éªŒè¯æµ‹è¯•è„šæœ¬

## ğŸš€ å‘å‰å…¼å®¹æ€§

- âœ… **ç°æœ‰å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹** - ä¸å‘é€ç”³è¯·äººå§“åæ—¶ä½¿ç”¨é»˜è®¤è¡Œä¸º
- âœ… **ç°æœ‰æ•°æ®åº“è®°å½•ä¸å—å½±å“** - ä¿®å¤ä»…å½±å“æ–°åˆ›å»ºçš„è®°å½•
- âœ… **APIæ¥å£å‘åå…¼å®¹** - `applicant_name` ä¸ºå¯é€‰å­—æ®µ

## ğŸ”’ æƒé™ä¸å®‰å…¨

### å½“å‰å®ç°
- ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä¸ºä»–äººä»£ç†ç”³è¯·
- `applicant_id` å§‹ç»ˆä¸ºå½“å‰ç™»å½•ç”¨æˆ·ID (ä¿è¯å®¡è®¡è¿½è¸ª)

### å¯é€‰çš„æƒé™æ§åˆ¶ (æœªå®ç°)
å¦‚æœä¸šåŠ¡éœ€è¦é™åˆ¶ä»£ç†ç”³è¯·æƒé™ï¼Œå¯ä»¥æ·»åŠ ï¼š

```javascript
// ä»…ç®¡ç†å‘˜å¯ä»¥ä»£ç†ç”³è¯·
const loanData = {
  ...req.body,
  applicant_name: req.user.role === 'admin' 
    ? req.body.applicant_name 
    : req.user.real_name,
  applicant_id: req.user._id
}
```

## âœ¨ ä¿®å¤å®Œæˆ

**çŠ¶æ€**: ğŸŸ¢ å·²ä¿®å¤  
**ä¼˜å…ˆçº§**: é«˜  
**å½±å“**: æ”¯æŒä»£ç†ç”³è¯·åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ  
**æµ‹è¯•**: å…¨éƒ¨é€šè¿‡  
**å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹  

---

**ä¿®å¤äºº**: AI Assistant  
**å®Œæˆæ—¶é—´**: 2025-05-28 07:27 UTC  
**æµ‹è¯•è„šæœ¬**: `./test-applicant-name-fix.sh` 